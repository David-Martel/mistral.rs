# Project-specific Cargo configuration for mistral.rs
# Optimized for CUDA builds on Windows with sccache and fast linking

[build]
# Use local target directory (overrides CARGO_TARGET_DIR env var if set in config.toml)
# Note: Environment variable CARGO_TARGET_DIR takes precedence over this setting
# For local builds, ensure CARGO_TARGET_DIR is NOT set in environment
target-dir = "target"

# Use sccache for compilation caching (30-80% faster rebuilds)
# Note: sccache is disabled during coverage builds via --no-cfg-coverage
rustc-wrapper = "sccache"

# Parallel compilation jobs
jobs = 8

[env]
SCCACHE_SERVER_PORT = "4226"
SCCACHE_CACHE_COMPRESSION = "zstd"
# sccache configuration
RUSTC_WRAPPER = "sccache"
SCCACHE_DIR = "T:/RustCache/sccache"
SCCACHE_CACHE_SIZE = "30G"
SCCACHE_IDLE_TIMEOUT = "3600"
SCCACHE_DIRECT = "true"

# IMPORTANT: Incremental compilation is disabled for sccache compatibility
# cargo-llvm-cov will override this to "1" automatically
CARGO_INCREMENTAL = "0"

# Force MSVC cl.exe as the C compiler (overrides Strawberry Perl's GCC in PATH)
# Full path needed because cl.exe isn't in PATH outside VS Developer Prompt
CC = "C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.44.35207\\bin\\Hostx64\\x64\\cl.exe"
CXX = "C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.44.35207\\bin\\Hostx64\\x64\\cl.exe"

# MSVC include/lib paths (required when not in Developer Command Prompt)
# MSVC 14.44.35207 + Windows SDK 10.0.26100.0
INCLUDE = "C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.44.35207\\include;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.26100.0\\ucrt;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.26100.0\\shared;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.26100.0\\um;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.26100.0\\winrt"
LIB = "C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.44.35207\\lib\\x64;C:\\Program Files (x86)\\Windows Kits\\10\\Lib\\10.0.26100.0\\ucrt\\x64;C:\\Program Files (x86)\\Windows Kits\\10\\Lib\\10.0.26100.0\\um\\x64"

# CUDA/cuDNN/MKL runtime paths
CUDA_PATH = "C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v12.9"
CUDNN_PATH = "C:\\Program Files\\NVIDIA\\CUDNN\\v9.8"
CUDNN_LIB = "C:\\Program Files\\NVIDIA\\CUDNN\\v9.8\\lib\\12.8\\x64"
MKLROOT = "C:\\Program Files (x86)\\Intel\\oneAPI\\mkl\\latest"

# NVCC host compiler path (required for CUDA kernel compilation on Windows)
NVCC_CCBIN = "C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.44.35207\\bin\\Hostx64\\x64\\cl.exe"

[target.x86_64-pc-windows-msvc]
# Use MSVC link.exe â€” lld/rust-lld breaks native C libraries (sqlite3 ___chkstk_ms issue)
# Rust 1.88+ defaults to lld on Windows, so explicit link.exe is required
linker = "link.exe"
rustflags = [
    "-C", "target-cpu=native",
]

[target.aarch64-apple-darwin]
rustflags = [
  "-C", "target-cpu=native",
  "-C", "target-feature=+aes,+sha2,+fp16",
]

[target.x86_64-apple-darwin]
rustflags = [
  "-C", "target-cpu=native",
  "-C", "target-feature=-avx,-avx2",
]

# Profile configurations
[profile.dev]
# Development profile with debug info
opt-level = 0
debug = true
debug-assertions = true
overflow-checks = true
incremental = true  # Enable incremental for dev builds

[profile.release]
# Release profile with optimizations
opt-level = 3
lto = "thin"
debug = false
incremental = false

[profile.test]
# Test profile inherits from dev but can be customized
inherits = "dev"
opt-level = 0

[profile.bench]
# Benchmark profile inherits from release
inherits = "release"


