[{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292623","pull_request_review_id":3316879812,"id":2415292623,"node_id":"PRRC_kwDOP7kehM6P9nDP","diff_hunk":"@@ -242,16 +242,22 @@ impl AnyMoeTrainableLayer for MoeMlp {\n         if self.gate.lin.weight().is_variable() {\n             sum += self.gate.lin.weight().elem_count();\n         }\n-        if self.gate.lin.bias().as_ref().unwrap().is_variable() {\n-            sum += self.gate.lin.bias().unwrap().elem_count();\n+        if let Some(bias) = self.gate.lin.bias().as_ref() {\n+            if bias.is_variable() {\n+                sum += bias.elem_count();\n+            }\n         }\n         sum\n     }\n     fn get_vars(&self) -> Vec<Var> {\n         self.vars.clone()\n     }\n     fn take_cached_gating_output(&mut self) -> Tensor {\n-        self.gating_output.read().unwrap().clone().unwrap()\n+        self.gating_output\n+            .read()\n+            .expect(\"Failed to acquire read lock on gating output\")","path":"mistralrs-core/src/amoe/mod.rs","commit_id":"814e6631d9fa6ba052a49a12b8d2069e9b71b66d","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `expect()` here is an improvement over `unwrap()`, but it will still cause a panic if the `RwLock` is poisoned. A more robust approach is to handle the `PoisonError` gracefully, which is especially important in concurrent code. The idiomatic way to handle this is to use `unwrap_or_else` to recover the lock's inner data.\n\n```suggestion\n            .unwrap_or_else(|poisoned| poisoned.into_inner())\n```","created_at":"2025-10-09T00:28:12Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292623","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292623"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292623"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292623/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":258,"side":"RIGHT","original_position":20,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292626","pull_request_review_id":3316879812,"id":2415292626,"node_id":"PRRC_kwDOP7kehM6P9nDS","diff_hunk":"@@ -268,7 +274,10 @@ impl MlpLayer for MoeMlp {\n         let TopKOutput { values: _, indices } = gate.topk(1)?;\n \n         if self.training {\n-            *self.gating_output.write().unwrap() = Some(gate.clone());\n+            *self\n+                .gating_output\n+                .write()\n+                .expect(\"Failed to acquire write lock on gating output\") = Some(gate.clone());","path":"mistralrs-core/src/amoe/mod.rs","commit_id":"23b733f81df39fefe5e3b69575d3aec21ae805eb","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nSimilar to the read lock, using `expect()` on a write lock can lead to a panic if the lock is poisoned. It's better to handle the `PoisonError` to prevent the thread from crashing. Using `unwrap_or_else` to recover from a poisoned lock is the recommended pattern.\n\n```suggestion\n                .unwrap_or_else(|poisoned| poisoned.into_inner()) = Some(gate.clone());\n```","created_at":"2025-10-09T00:28:12Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292626","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292626"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292626"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292626/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":280,"side":"RIGHT","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292630","pull_request_review_id":3316879812,"id":2415292630,"node_id":"PRRC_kwDOP7kehM6P9nDW","diff_hunk":"@@ -541,29 +547,51 @@ impl Engine {\n \n     fn replicate_request_to_daemons(&self, request: &Request) {\n         if !distributed::is_daemon() && mistralrs_quant::distributed::use_nccl() {\n-            let name = distributed::ipc_name().unwrap();\n-            let num_workers =\n-                mistralrs_quant::distributed::get_global_tp_size_from_devices().unwrap() - 1;\n-            let listener = ListenerOptions::new().name(name).create_sync().unwrap();\n+            let name = distributed::ipc_name()\n+                .expect(\"Failed to get IPC name for distributed communication\");","path":"mistralrs-core/src/engine/mod.rs","commit_id":"2520e97b2ec4c04c98c37ca01be1009f20fdc307","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nWhile `expect()` is better than `unwrap()`, this function `replicate_request_to_daemons` performs several I/O and serialization operations that can fail at runtime for reasons other than programming errors (e.g., IPC issues, serialization failures). A panic in this function will crash the engine thread.\n\nConsider refactoring this function to return a `Result<()>` and propagate errors to the caller. This would allow for more graceful error handling, such as logging the issue and attempting to continue or shutting down cleanly, rather than panicking immediately.","created_at":"2025-10-09T00:28:12Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292630","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292630"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292630"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292630/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":551,"original_line":551,"side":"RIGHT","original_position":48,"position":48,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292635","pull_request_review_id":3316879812,"id":2415292635,"node_id":"PRRC_kwDOP7kehM6P9nDb","diff_hunk":"@@ -24,7 +24,7 @@ impl EitherCache {\n     /// Panics otherwise!\n     pub fn normal(&self) -> MutexGuard<'_, NormalCache> {\n         match self {\n-            Self::Normal(normal) => normal.lock().unwrap(),\n+            Self::Normal(normal) => normal.lock().expect(\"Cache operation failed\"),","path":"mistralrs-core/src/kv_cache/full_cache.rs","commit_id":"19b821674eb841edf4079510d11add73c882c240","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `expect()` here is an improvement over `unwrap()`, but it will still cause a panic if the `Mutex` is poisoned. A more robust approach is to handle the `PoisonError` gracefully. The idiomatic way to handle this is to use `unwrap_or_else` to recover the lock's inner data.\n\n```suggestion\n            Self::Normal(normal) => normal.lock().unwrap_or_else(|p| p.into_inner()),\n```","created_at":"2025-10-09T00:28:12Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292635","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292635"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292635"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292635/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":27,"side":"RIGHT","original_position":5,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292643","pull_request_review_id":3316879812,"id":2415292643,"node_id":"PRRC_kwDOP7kehM6P9nDj","diff_hunk":"@@ -249,50 +250,84 @@ impl<T: CacheManagerMixin + MetadataMixin + ?Sized> CacheManager<T> for NormalCa\n                 } else {\n                     seqs[0].normal_cache()\n                 };\n-                let Some(cache) = src_cache.get(layer).unwrap().as_ref() else {\n+                let Some(cache) = src_cache\n+                    .get(layer)\n+                    .expect(\"Cache layer should exist for model\")\n+                    .as_ref()\n+                else {\n                     // This is hit in gemma3n for the shared kv cache\n                     new_k_cache.push(None);\n                     new_v_cache.push(None);\n                     continue;\n                 };\n                 match cache {\n-                    KvCache::Normal { k, v } => {\n-                        (k.all_data.clone().unwrap(), v.all_data.clone().unwrap())\n-                    }\n-                    KvCache::Rotating { k, v } => {\n-                        (k.all_data.clone().unwrap(), v.all_data.clone().unwrap())\n-                    }\n+                    KvCache::Normal { k, v } => (\n+                        k.all_data\n+                            .clone()\n+                            .expect(\"Cache data should be initialized\"),\n+                        v.all_data\n+                            .clone()\n+                            .expect(\"Cache data should be initialized\"),\n+                    ),\n+                    KvCache::Rotating { k, v } => (\n+                        k.all_data\n+                            .clone()\n+                            .expect(\"Cache data should be initialized\"),\n+                        v.all_data\n+                            .clone()\n+                            .expect(\"Cache data should be initialized\"),\n+                    ),\n                 }\n             };\n             // Build dims for batched cache\n             let mut dims_k = first_k.dims().to_vec();\n             let mut dims_v = first_v.dims().to_vec();\n             dims_k[0] *= batch_len;\n             dims_v[0] *= batch_len;\n-            let batch_k = Tensor::zeros(dims_k.clone(), first_k.dtype(), first_k.device()).unwrap();\n-            let batch_v = Tensor::zeros(dims_v.clone(), first_v.dtype(), first_v.device()).unwrap();\n+            let batch_k = Tensor::zeros(dims_k.clone(), first_k.dtype(), first_k.device())\n+                .expect(\"Failed to allocate batch K cache tensor - out of memory?\");","path":"mistralrs-core/src/kv_cache/mod.rs","commit_id":"2520e97b2ec4c04c98c37ca01be1009f20fdc307","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `expect()` for tensor allocation can lead to a panic on out-of-memory (OOM) errors. While the message is helpful for debugging, it abruptly terminates the process. Given that this is a core part of the cache management, it would be more robust for `clone_in_cache` to return a `Result` and propagate the error. This would allow the engine to handle OOM errors more gracefully, for example by rejecting new requests until memory is freed.","created_at":"2025-10-09T00:28:12Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292643","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292643"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292643"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292643/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":288,"original_line":288,"side":"RIGHT","original_position":60,"position":60,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292647","pull_request_review_id":3316879812,"id":2415292647,"node_id":"PRRC_kwDOP7kehM6P9nDn","diff_hunk":"@@ -114,11 +114,15 @@ impl RotatingCache {\n             let mut shape = src.dims().to_vec();\n             shape[self.dim] = self.capacity_seq_len;\n             let ad = Tensor::zeros(shape, src.dtype(), src.device())?;\n-            ad.slice_set(self.all_data.as_ref().unwrap(), self.dim, 0)?;\n+            ad.slice_set(\n+                self.all_data.as_ref().expect(\"Cache operation failed\"),","path":"mistralrs-core/src/kv_cache/rotating_cache.rs","commit_id":"2520e97b2ec4c04c98c37ca01be1009f20fdc307","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `expect()` here is risky. The `if self.all_data.is_none()` block above does not guarantee that `self.all_data` will be `Some` at this point, especially if the capacity check logic is complex. If `self.all_data` is `None` and the capacity needs to be expanded, this will panic.\n\nConsider using `if let Some(all_data) = self.all_data.as_ref()` to safely unwrap and handle the `None` case, or restructure the logic to ensure `all_data` is always initialized before this point.","created_at":"2025-10-09T00:28:12Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292647","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292647"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292647"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292647/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":118,"original_line":118,"side":"RIGHT","original_position":6,"position":6,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292653","pull_request_review_id":3316879812,"id":2415292653,"node_id":"PRRC_kwDOP7kehM6P9nDt","diff_hunk":"@@ -98,11 +98,15 @@ impl SingleCache {\n             let mut shape = src.dims().to_vec();\n             shape[self.dim] = self.capacity_seq_len;\n             let ad = Tensor::zeros(shape, src.dtype(), src.device())?;\n-            ad.slice_set(self.all_data.as_ref().unwrap(), self.dim, 0)?;\n+            ad.slice_set(\n+                self.all_data.as_ref().expect(\"Cache operation failed\"),","path":"mistralrs-core/src/kv_cache/single_cache.rs","commit_id":"2520e97b2ec4c04c98c37ca01be1009f20fdc307","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nSimilar to `rotating_cache.rs`, using `expect()` here is risky. The logic for cache expansion should be structured to avoid panics if `self.all_data` is `None` when an expansion is needed. Using `if let` or `get_or_insert_with` would be safer patterns to ensure the cache tensor is initialized before use.","created_at":"2025-10-09T00:28:12Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292653","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292653"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292653"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292653/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":102,"original_line":102,"side":"RIGHT","original_position":6,"position":6,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292656","pull_request_review_id":3316879812,"id":2415292656,"node_id":"PRRC_kwDOP7kehM6P9nDw","diff_hunk":"@@ -1203,8 +1214,11 @@ impl AnyMoePipelineMixin for NormalPipeline {\n                     if regex.is_match(&key) {\n                         // Idx of the last char of the layer id, +1\n                         // Assumes N.MLP\n-                        let last_layer_idx = key.find(&match_regex_clone).unwrap() - 1;\n-                        let first_layer_idx = key[..last_layer_idx].rfind('.').unwrap();\n+                        let last_layer_idx =\n+                            key.find(&match_regex_clone).expect(\"Pattern should exist\") - 1;\n+                        let first_layer_idx = key[..last_layer_idx]\n+                            .rfind('.')\n+                            .expect(\"Pattern should exist\");\n                         let layer_n = key[first_layer_idx + 1..last_layer_idx]\n                             .parse::<usize>()\n                             .unwrap();","path":"mistralrs-core/src/pipeline/normal.rs","commit_id":"fdbc1a96be6b31d128a3fdf1c48da66d37182fa3","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis `unwrap()` can panic if parsing the layer number from the key fails. It's better to handle this with a `Result` and propagate the error, or at least use `expect()` with a descriptive message to make debugging easier if a malformed key is encountered.\n\n```suggestion\n                            .expect(\"Failed to parse layer number from tensor key\");\n```","created_at":"2025-10-09T00:28:13Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292656","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292656"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292656"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292656/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":1224,"side":"RIGHT","original_position":90,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292659","pull_request_review_id":3316879812,"id":2415292659,"node_id":"PRRC_kwDOP7kehM6P9nDz","diff_hunk":"@@ -250,7 +250,7 @@ pub fn get_xlora_paths(\n                             }\n                         }\n \n-                        let (config, safetensor) = (config.unwrap(), safetensor.unwrap());\n+                        let (config, safetensor) = (config.expect(\"Config required\"), safetensor.unwrap());","path":"mistralrs-core/src/pipeline/paths.rs","commit_id":"2520e97b2ec4c04c98c37ca01be1009f20fdc307","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe `unwrap()` on `safetensor` remains, which could cause a panic if a safetensor file is not found for an adapter. It would be safer to use `expect()` with a clear message or, even better, propagate an error indicating that the required file is missing.\n\n```suggestion\n                        let (config, safetensor) = (config.expect(\"Config required\"), safetensor.expect(\"Safetensor file required\"));\n```","created_at":"2025-10-09T00:28:13Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292659","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292659"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292659"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292659/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":253,"original_line":253,"side":"RIGHT","original_position":23,"position":23,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292660","pull_request_review_id":3316879812,"id":2415292660,"node_id":"PRRC_kwDOP7kehM6P9nD0","diff_hunk":"@@ -495,10 +511,11 @@ pub(crate) fn get_chat_template(\n         template.chat_template = Some(ChatTemplateValue(Either::Left(ct)));\n     }\n \n-    let processor_conf: Option<crate::vision_models::processor_config::ProcessorConfig> = paths\n-        .get_processor_config()\n-        .as_ref()\n-        .map(|f| serde_json::from_str(&fs::read_to_string(f).unwrap()).unwrap());\n+    let processor_conf: Option<crate::vision_models::processor_config::ProcessorConfig> =\n+        paths.get_processor_config().as_ref().map(|f| {\n+            serde_json::from_str(&fs::read_to_string(f).expect(\"Failed to parse JSON\"))\n+                .expect(\"Failed to parse JSON\")","path":"mistralrs-core/src/pipeline/paths.rs","commit_id":"2520e97b2ec4c04c98c37ca01be1009f20fdc307","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `expect()` on `read_to_string` can be misleading. This operation can fail due to I/O errors (e.g., file not found, permissions issues), not just parsing problems. It would be better to propagate the `io::Result` using `?` and let the caller handle the I/O error appropriately, perhaps with more context about the file path.","created_at":"2025-10-09T00:28:13Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292660","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292660"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292660"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292660/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":517,"original_line":517,"side":"RIGHT","original_position":99,"position":99,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292662","pull_request_review_id":3316879812,"id":2415292662,"node_id":"PRRC_kwDOP7kehM6P9nD2","diff_hunk":"@@ -664,9 +670,11 @@ impl Sequence {\n         }\n         // Use xlora cache first because of non granular\n         if self.xlora_cache.as_ref().is_some_and(|c| c[0].is_some()) {\n-            self.xlora_cache.as_ref().unwrap()[0]\n+            self.xlora_cache\n                 .as_ref()\n-                .unwrap()\n+                .expect(\"XLora cache should be initialized\")[0]\n+                .as_ref()\n+                .expect(\"XLora cache layer 0 should be present\")\n                 .0","path":"mistralrs-core/src/sequence.rs","commit_id":"2520e97b2ec4c04c98c37ca01be1009f20fdc307","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis chain of `expect()` calls is fragile and can panic if any of the assumptions about the cache state are violated. A safer approach would be to use `if let` or `and_then` to gracefully handle cases where the cache or specific layers are not initialized. This avoids panics and makes the code more resilient to unexpected states.\n\n```suggestion\n        if let Some(cache) = self.xlora_cache.as_ref() {\n            if let Some(Some((k, _))) = cache.get(0) {\n                return k.dims()[2] + 1;\n            }\n        }\n```","created_at":"2025-10-09T00:28:13Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292662","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292662"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292662"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292662/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":673,"original_start_line":673,"start_side":"RIGHT","line":678,"original_line":678,"side":"RIGHT","original_position":40,"position":40,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292663","pull_request_review_id":3316879812,"id":2415292663,"node_id":"PRRC_kwDOP7kehM6P9nD3","diff_hunk":"@@ -495,16 +495,16 @@ impl Model {\n             info!(\"Merging LoRA adapters.\");\n             for layer in layers.iter_mut().tqdm() {\n                 Arc::get_mut(&mut layer.self_attn.k_proj)\n-                    .unwrap()\n+                    .expect(\"Multiple references to k_proj\")\n                     .merge_weights()?;\n                 Arc::get_mut(&mut layer.self_attn.dense)\n                     .unwrap()","path":"mistralrs-core/src/xlora_models/phi2.rs","commit_id":"04db307e8b6d61d174dbee815f11cc6d1f9149c4","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nIt seems this `unwrap()` was missed during the refactoring. It should be replaced with `expect()` to provide a descriptive error message if `Arc::get_mut` returns `None`, consistent with the changes made to other projections in this file.\n\n```suggestion\n                    .expect(\"Multiple references to dense layer\")\n```","created_at":"2025-10-09T00:28:13Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292663","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292663"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292663"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292663/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":501,"side":"RIGHT","original_position":8,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292665","pull_request_review_id":3316879812,"id":2415292665,"node_id":"PRRC_kwDOP7kehM6P9nD5","diff_hunk":"@@ -497,21 +497,23 @@ impl Model {\n             info!(\"Merging LoRA adapters.\");\n             for layer in layers.iter_mut().tqdm() {\n                 Arc::get_mut(&mut layer.self_attn.k_proj)\n-                    .unwrap()\n+                    .expect(\"Multiple references to k_proj layer\")\n                     .merge_weights()?;\n                 Arc::get_mut(&mut layer.self_attn.o_proj)\n-                    .unwrap()\n+                    .expect(\"Multiple references to o_proj layer\")\n                     .merge_weights()?;\n                 Arc::get_mut(&mut layer.self_attn.q_proj)\n-                    .unwrap()\n+                    .expect(\"Multiple references to q_proj layer\")\n                     .merge_weights()?;\n                 Arc::get_mut(&mut layer.self_attn.v_proj)\n-                    .unwrap()\n+                    .expect(\"Multiple references to v_proj layer\")\n                     .merge_weights()?;\n \n-                Arc::get_mut(&mut layer.mlp.c_fc).unwrap().merge_weights()?;\n+                Arc::get_mut(&mut layer.mlp.c_fc)\n+                    .expect(\"Multiple references to c_fc layer\")\n+                    .merge_weights()?;","path":"mistralrs-core/src/xlora_models/starcoder2.rs","commit_id":"11c8be3ecddc8b123bd6759f0cf010eb01679315","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis `unwrap()` seems to have been missed. To maintain consistency with the other changes in this file and improve error handling, it should be replaced with `expect()` and a descriptive message.\n\n```suggestion\n                    .expect(\"Multiple references to c_proj layer\")\n```","created_at":"2025-10-09T00:28:13Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292665","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292665"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292665"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292665/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":514,"side":"RIGHT","original_position":23,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292666","pull_request_review_id":3316879812,"id":2415292666,"node_id":"PRRC_kwDOP7kehM6P9nD6","diff_hunk":"@@ -179,16 +187,24 @@ pub async fn agent_mode(mistralrs: Arc<MistralRs>, do_search: bool) {\n     info!(\"Starting agent mode with sampling params: {sampling_params:?}\");\n     println!(\"{}{}{}\", \"=\".repeat(20), AGENT_MODE_HELP, \"=\".repeat(20));\n \n-    *CTRLC_HANDLER.lock().unwrap() = &exit_handler;\n+    *CTRLC_HANDLER\n+        .lock()\n+        .expect(\"Control-C handler mutex poisoned\") = &exit_handler;","path":"mistralrs-server/src/agent_mode.rs","commit_id":"99664c2d06836abbcd28cbc9fdb27b3f8d2100a0","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `expect()` here is an improvement over `unwrap()`, but it will still cause a panic if the `Mutex` is poisoned. A more robust approach is to handle the `PoisonError` gracefully, which is especially important for a long-running server process. The idiomatic way to handle this is to use `unwrap_or_else` to recover the lock's inner data.\n\n```suggestion\n        .lock()\n        .unwrap_or_else(|poisoned| poisoned.into_inner()) = &exit_handler;\n```","created_at":"2025-10-09T00:28:13Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292666","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292666"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292666"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292666/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":192,"side":"RIGHT","original_position":49,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292667","pull_request_review_id":3316879812,"id":2415292667,"node_id":"PRRC_kwDOP7kehM6P9nD7","diff_hunk":"@@ -246,16 +254,24 @@ async fn text_interactive_mode(\n     );\n \n     // Set the handler to process exit\n-    *CTRLC_HANDLER.lock().unwrap() = &exit_handler;\n+    *CTRLC_HANDLER\n+        .lock()\n+        .expect(\"Control-C handler mutex poisoned\") = &exit_handler;","path":"mistralrs-server/src/interactive_mode.rs","commit_id":"2520e97b2ec4c04c98c37ca01be1009f20fdc307","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `expect()` here is an improvement over `unwrap()`, but it will still cause a panic if the `Mutex` is poisoned. A more robust approach is to handle the `PoisonError` gracefully, which is especially important for a long-running server process. The idiomatic way to handle this is to use `unwrap_or_else` to recover the lock's inner data.\n\n```suggestion\n        .lock()\n        .unwrap_or_else(|poisoned| poisoned.into_inner()) = &exit_handler;\n```","created_at":"2025-10-09T00:28:14Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292667","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292667"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292667"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292667/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":259,"original_line":259,"side":"RIGHT","original_position":53,"position":53,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292669","pull_request_review_id":3316879812,"id":2415292669,"node_id":"PRRC_kwDOP7kehM6P9nD9","diff_hunk":"@@ -798,11 +853,20 @@ async fn diffusion_interactive_mode(mistralrs: Arc<MistralRs>, do_search: bool)\n         }));\n \n         let start = Instant::now();\n-        sender.send(req).await.unwrap();\n-\n-        let ResponseOk::ImageGeneration(response) = rx.recv().await.unwrap().as_result().unwrap()\n+        sender\n+            .send(req)\n+            .await\n+            .expect(\"Failed to send request to model\");\n+\n+        let ResponseOk::ImageGeneration(response) = rx\n+            .recv()\n+            .await\n+            .expect(\"Channel closed\")\n+            .as_result()\n+            .expect(\"Request failed\")","path":"mistralrs-server/src/interactive_mode.rs","commit_id":"5ffdd9008ab1b992af456902c1d9765dde13f86a","original_commit_id":"3daf608ab389a686961b2a24f43e32704434dfd3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `expect()` on the result of a request can cause the server to panic if the request fails for any reason. A more robust approach would be to handle the `Err` case gracefully, for example by logging the error and returning an appropriate error message to the user, rather than crashing the interactive session.\n\n```suggestion\n            .as_result()\n            .map_err(|e| {\n                eprintln!(\"Error: Request failed: {}\", e);\n                e\n            })\n            .ok()\n```","created_at":"2025-10-09T00:28:14Z","updated_at":"2025-10-09T00:28:14Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292669","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292669"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415292669"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415292669/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":866,"side":"RIGHT","original_position":297,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415362663","pull_request_review_id":3316961553,"id":2415362663,"node_id":"PRRC_kwDOP7kehM6P94Jn","diff_hunk":"@@ -118,24 +118,173 @@ impl T5RelativeAttentionLogitBias {\n \n         // Map to bias indices\n         let bias_idx = if self.skip_bucketing {\n-            relative_position\n+            let idx = if self.symmetric {\n+                relative_position.abs()?\n+            } else {\n+                let offset = (self.bias_values.embeddings().dim(0)? / 2) as i64;\n+                (relative_position + offset as f64)?\n+            };\n+            idx.to_dtype(DType::U32)?\n         } else {\n-            // TODO: Implement skip_bucketing positional embedding branch\n-            unimplemented!(\"require skip_bucketing\");\n+            self.bucketize_relative_positions(&relative_position)?\n         };\n \n-        let bias_idx = if self.symmetric {\n-            bias_idx.abs()?\n+        // Get bias values\n+        let t5_rel_att_bias = self.bias_values.forward(&bias_idx)?; // [L, L, H]\n+        t5_rel_att_bias.permute((2, 0, 1))?.unsqueeze(0) // [1, H, L, L]\n+    }\n+\n+    fn bucketize_relative_positions(&self, relative_position: &Tensor) -> Result<Tensor> {\n+        let device = relative_position.device();\n+        let dims = relative_position.dims();\n+        let total_buckets = self.bias_values.embeddings().dim(0)? as i64;\n+        if total_buckets <= 0 {\n+            candle_core::bail!(\"Relative attention bias must have at least one bucket.\");\n+        }\n+        let max_distance = self.max_distance as i64;\n+        let positions = relative_position.flatten_all()?.to_vec1::<f32>()?;\n+        let mut buckets = Vec::with_capacity(positions.len());\n+        for raw in positions {\n+            let position = raw.round() as i64;\n+            let bucket = self.assign_bucket(position, total_buckets, max_distance);\n+            buckets.push(bucket as u32);\n+        }\n+        Tensor::from_vec(buckets, dims, device)\n+    }\n+\n+    fn assign_bucket(&self, position: i64, total_buckets: i64, max_distance: i64) -> i64 {\n+        if total_buckets <= 1 {\n+            return 0;\n+        }\n+        let mut bucket = if self.symmetric {\n+            let half = (total_buckets / 2).max(1);\n+            let offset = if position > 0 { half } else { 0 };\n+            let abs_pos = position.abs();\n+            offset + self.bucket_single_side(abs_pos, half, max_distance)\n         } else {\n-            let offset = (self.bias_values.embeddings().dim(0)? / 2) as i64;\n-            (bias_idx + offset as f64)?\n+            let pos = if position < 0 { -position } else { 0 };\n+            self.bucket_single_side(pos, total_buckets, max_distance)","path":"mistralrs-core/src/vision_models/conformer/pos_embed.rs","commit_id":"2520e97b2ec4c04c98c37ca01be1009f20fdc307","original_commit_id":"df9b17aa90d2fd23f42fab2d57001fcd38383bbe","user":{"login":"chatgpt-codex-connector[bot]","id":199175422,"node_id":"BOT_kgDOC98s_g","avatar_url":"https://avatars.githubusercontent.com/in/1144995?v=4","gravatar_id":"","url":"https://api.github.com/users/chatgpt-codex-connector%5Bbot%5D","html_url":"https://github.com/apps/chatgpt-codex-connector","followers_url":"https://api.github.com/users/chatgpt-codex-connector%5Bbot%5D/followers","following_url":"https://api.github.com/users/chatgpt-codex-connector%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/chatgpt-codex-connector%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/chatgpt-codex-connector%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chatgpt-codex-connector%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/chatgpt-codex-connector%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/chatgpt-codex-connector%5Bbot%5D/repos","events_url":"https://api.github.com/users/chatgpt-codex-connector%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/chatgpt-codex-connector%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"**<sub><sub>![P1 Badge](https://img.shields.io/badge/P1-orange?style=flat)</sub></sub>  Preserve positive offsets when bucketing nonsymmetric relative positions**\n\nIn `assign_bucket` the nonsymmetric branch sets `pos` to `0` whenever `position >= 0` and then buckets using the full `total_buckets`. This collapses every positive relative position into bucket `0`, regardless of distance. Conformer encoders instantiate `T5RelativeAttentionLogitBias` with `t5_bias_symmetric` defaulting to `false`, so positive offsets are expected to occupy their own bucket range (the constructor even doubles `num_buckets` to hold both directions). With the current logic the model will always fetch the same bias embedding for all forward positions, producing incorrect attention logits. The positive side should be bucketized just like the negative side, with an offset for separating the two halves, instead of being forced to 0.\n\nUseful? React with / .","created_at":"2025-10-09T01:42:41Z","updated_at":"2025-10-09T01:42:41Z","html_url":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415362663","pull_request_url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2","author_association":"NONE","_links":{"self":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415362663"},"html":{"href":"https://github.com/david-t-martel/mistral.rs/pull/2#discussion_r2415362663"},"pull_request":{"href":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/2"}},"reactions":{"url":"https://api.github.com/repos/david-t-martel/mistral.rs/pulls/comments/2415362663/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":155,"original_start_line":155,"start_side":"RIGHT","line":166,"original_line":166,"side":"RIGHT","original_position":56,"position":56,"subject_type":"line"}]
